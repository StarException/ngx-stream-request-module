!function(t){"use strict";function e(){this.reqID=0,this.state=r.Success,this.data=null}var n=t.stm=t.stm||{},r={Success:0,Failed:1};n.Response=e,n.Response.State=r}(this),function(t){"use strict";var e=t.stm=t.stm||{};e.ContentProtocol={onOpen:function(t){t()},onClose:function(){},parse:function(t){return new e.Response},build:function(t,e,n){return new ArrayBuffer(2)},buildFailedMessage:function(t,e){return new ArrayBuffer(2)},extend:function(t){if(t.__proto__)t.__proto__=this;else{for(var e in this)this.hasOwnProperty(e)&&!t.hasOwnProperty(e)&&(t[e]=this[e]);this.hasOwnProperty("toString")&&!t.hasOwnProperty("toString")&&(t.toString=this.toString)}return t.$parent=this,t}}}(this),function(t){"use strict";var e=t.stm=t.stm||{};e.DefaultContentProtocol={parse:function(t){var n=new e.Response,r=new DataView(t);return n.reqID=r.getUint32(0),n.state=0==r.getUint8(4)?e.Response.State.Success:e.Response.State.Failed,n.data=t.slice(5),n},build:function(t,e,n){if(t=t||"","string"!=typeof t&&!(t instanceof ArrayBuffer))return"body type is error, must be string or ArrayBuffer";if(e=e||{},"object"!=typeof e)return"headers must be a object type, for example {uri: '/location'}";var r=0;for(var o in e)if(e.hasOwnProperty(o)){if("string"!=typeof o||"string"!=typeof e[o])return"headers' key or property must be string";if(o.length>255)return"length of headers' key <"+o+"> more than 255";if(e[o].length>255)return"length of headers' object <"+e[o]+"> more than 255";0!=o.length&&0!=e[o].length&&(r+=2+o.length+e[o].length)}t=new StringView(t);var i=new ArrayBuffer(4+t.rawData.byteLength+1+r);new DataView(i).setUint32(0,n);var s=4;for(o in e)e.hasOwnProperty(o)&&(new DataView(i).setUint8(s,o.length),s++,new Uint8Array(i).set(new StringView(o).rawData,s),s+=o.length,new DataView(i).setUint8(s,e[o].length),s++,new Uint8Array(i).set(new StringView(e[o]).rawData,s),s+=e[o].length);return new DataView(i).setUint8(s,0),s++,new Uint8Array(i).set(t.rawData,s),i},buildFailedMessage:function(t,n){t=new StringView(t);var r=new ArrayBuffer(4+t.rawData.byteLength+1);return new DataView(r).setUint32(0,n),new DataView(r).setUint8(4,e.Response.State.Failed),new Uint8Array(r).set(t.rawData,5),r}}}(this),function(t){"use strict";function e(t,e,n,r,o,i){this.body=t||"",this.headers=n||{},this.onSuccess=e||function(t){},this.onFailed=r||function(t){},this.onComplete=o||function(){},this.reqID=i}function n(){function t(t){t.net_=null,t.netArgs_="",t.requests_=Object.create(null),t.protocol_=l.ContentProtocol.extend(l.DefaultContentProtocol),t.reqID_=s,t.onConnectionSuc_=function(){},t.onConnectionFaild_=function(t){},t.normalOnMessage_=function(t){},t.connectTimeout_=30}t(this),this.onPush=function(t){},this.onPushJson=null}function r(t){return new i(t)}function o(t){setTimeout(t,0)}function i(t){this.client_=t}if("function"!=typeof StringView)return void console.error("can not find StringView. this error maybe cause 'stm.Client is not a constructor'. you can find in https://developer.mozilla.org/en-US/Add-ons/Code_snippets/StringView or https://github.com/madmurphy/stringview.js");var s=200,a=1,u=n.prototype;u.setConnectArgs=function(t,e,n){this.netArgs_=t,this.onConnectionFaild_=n||function(t){},this.onConnectionSuc_=e||function(){}},u.setConfig=function(t){this.connectTimeout_=t},u.addJsonRequest=function(t,e,n,r,o){var i=null==e?null:function(t){e(JSON.parse(new StringView(t).toString()))};this.addRequest(JSON.stringify(null===t?null:t),i,n,r,o)},u.addRequest=function(t,n,o,i,s){if(null==this.netArgs_)return"function"==typeof s&&s(),void("function"==typeof i&&i("net args not set"));var a=r(this).getReqID();return this.requests_[a.toString()]=new e(t,n,o,i,s,a),null!=this.net_&&this.net_.readyState==WebSocket.OPEN?void r(this).sendRequest(this.requests_[a.toString()]):void(null!=this.net_&&this.net_.readyState==WebSocket.CONNECTING||r(this).connect())};var c=i.prototype;c.getReqID=function(){return this.client_.reqID_++,this.client_.reqID_<s&&(this.client_.reqID_=s),this.client_.reqID_},c.sendRequest=function(t){var e=this.client_,n=e.protocol_.build(t.body,t.headers,t.reqID);return"string"==typeof n?void o(function(){var r=e.protocol_.buildFailedMessage(n,t.reqID);e.net_.onmessage({data:r})}):void e.net_.send(n)},c.connect=function(){var t=this.client_;this.client_.normalOnMessage_=function(e){var n=t.protocol_.parse(e);if(n.reqID==a)return t.onPush(n.data),void(t.onPushJson&&t.onPushJson(JSON.parse(new StringView(n.data).toString())));var r=t.requests_[n.reqID.toString()];return null==r?void console.error("not find request for reqID<"+n.reqID+">"):(r.onComplete(),n.state!=l.Response.State.Success?null===n.data||void 0===n.data?r.onFailed("may be server error, but server has closed the error log"):r.onFailed(new StringView(n.data).toString()):r.onSuccess(n.data),void delete t.requests_[n.reqID.toString()])},this.client_.net_=new WebSocket(this.client_.netArgs_),t.net_.haserror=!1,t.net_.binaryType="arraybuffer",t.net_.onmessage=function(e){t.normalOnMessage_(e.data)};var e=setTimeout(function(){t.net_.timeout()},1e3*t.connectTimeout_),n=this;t.net_.onopen=function(r){null!=e&&(clearTimeout(e),e=null),n.sendAllRequest(),t.protocol_.onOpen(t.onConnectionSuc_)},t.net_.onclose=function(r){null!=e&&(clearTimeout(e),e=null),t.net_.close(1e3),t.protocol_.onClose(),t.net_.haserror||(t.net_.haserror=!1,n.netError("connection closed by peer or connection error"))},t.net_.onerror=function(r){t.net_.haserror=!0,null!=e&&(clearTimeout(e),e=null),n.netError("connect error---"+JSON.stringify(r))},t.net_.timeout=function(r){e=null,this.onopen=function(t){},this.onclose=function(t){},this.onerror=function(t){},this.onmessage=function(t){},t.net_=null,n.netError("connect timeout")}},c.sendAllRequest=function(){var t=this.client_;for(var e in t.requests_)this.sendRequest(t.requests_[e])},c.errorAllRequest=function(t){var e=this.client_;for(var n in e.requests_)!function(n){o(function(){e.normalOnMessage_(e.protocol_.buildFailedMessage(t,n))})}(Number(n))},c.netError=function(t){var e=this.client_;this.errorAllRequest(t),e.onConnectionFaild_(t)};var l=t.stm=t.stm||{};l.Client=n}(this);