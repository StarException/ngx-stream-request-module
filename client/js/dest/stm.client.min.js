!function(t){"use strict";function e(){this.reqID=0,this.state=o.Success,this.data=null}var n=t.stm=t.stm||{},o={Success:0,Failed:1};n.Response=e,n.Response.State=o}(this),function(t){"use strict";var e=t.stm=t.stm||{};e.ContentProtocol={onOpen:function(t){t()},onClose:function(){},parse:function(t){return new e.Response},build:function(t,e,n){return new ArrayBuffer(2)},buildFailedMessage:function(t,e){return new ArrayBuffer(2)},extend:function(t){if(t.__proto__)t.__proto__=this;else{for(var e in this)this.hasOwnProperty(e)&&!t.hasOwnProperty(e)&&(t[e]=this[e]);this.hasOwnProperty("toString")&&!t.hasOwnProperty("toString")&&(t.toString=this.toString)}return t.$parent=this,t}}}(this),function(t){"use strict";var e=t.stm=t.stm||{};e.DefaultContentProtocol={parse:function(t){var n=new e.Response,o=new DataView(t);return n.reqID=o.getUint32(0),n.state=0==o.getUint8(4)?e.Response.State.Success:e.Response.State.Failed,n.data=t.slice(5),n},build:function(t,e,n){if(t=t||"","string"!=typeof t&&!(t instanceof ArrayBuffer))return"body type is error, must be string or ArrayBuffer";if(e=e||{},"object"!=typeof e)return"headers must be a object type, for example {uri: '/location'}";var o=0;for(var r in e)if(e.hasOwnProperty(r)){if("string"!=typeof r||"string"!=typeof e[r])return"headers' key or property must be string";if(r.length>255)return"length of headers' key <"+r+"> more than 255";if(e[r].length>255)return"length of headers' object <"+e[r]+"> more than 255";0!=r.length&&0!=e[r].length&&(o+=2+r.length+e[r].length)}t=new StringView(t);var i=new ArrayBuffer(4+t.rawData.byteLength+1+o);new DataView(i).setUint32(0,n);var s=4;for(r in e)e.hasOwnProperty(r)&&(new DataView(i).setUint8(s,r.length),s++,new Uint8Array(i).set(new StringView(r).rawData,s),s+=r.length,new DataView(i).setUint8(s,e[r].length),s++,new Uint8Array(i).set(new StringView(e[r]).rawData,s),s+=e[r].length);return new DataView(i).setUint8(s,0),s++,new Uint8Array(i).set(t.rawData,s),i},buildFailedMessage:function(t,n){t=new StringView(t);var o=new ArrayBuffer(4+t.rawData.byteLength+1);return new DataView(o).setUint32(0,n),new DataView(o).setUint8(4,e.Response.State.Failed),new Uint8Array(o).set(t.rawData,5),o}}}(this),function(t){"use strict";function e(t,e,n,o,r,i){this.body=t||"",this.headers=n||{},this.onSuccess=e||function(t){},this.onFailed=o||function(t){},this.onComplete=r||function(){},this.reqID=i}function n(){function t(t){t.net_=null,t.netArgs_="",t.requests_=Object.create(null),t.protocol_=f.ContentProtocol.extend(f.DefaultContentProtocol),t.blockRequest_=null,t.isBlock_=!1,t.reqID_=s,t.onConnectionSuc_=function(){},t.onConnectionFaild_=function(t){},t.normalOnMessage_=function(t){},t.connectTimeout_=30}t(this),this.onPush=function(t){}}function o(t){return new i(t)}function r(t){setTimeout(t,0)}function i(t){this.client_=t}if("function"!=typeof StringView)return void console.error("can not find StringView. this error maybe cause 'stm.Client is not a constructor'. you can find in https://developer.mozilla.org/en-US/Add-ons/Code_snippets/StringView or https://github.com/madmurphy/stringview.js");var s=200,a=s-1,u=1,c=n.prototype;c.setConnectArgs=function(t,e,n){this.netArgs_=t,this.onConnectionFaild_=n||function(t){},this.onConnectionSuc_=e||function(){}},c.setConfig=function(t){this.connectTimeout_=t},c.setBlockRequestOnConnected=function(t,n,o,r,i){this.blockRequest_=new e(t,n,o,r,i,a)},c.addRequest=function(t,n,r,i,s){if(null==this.netArgs_)return"function"==typeof s&&s(),void("function"==typeof i&&i("net args not set"));var a=o(this).getReqID();return this.requests_[a.toString()]=new e(t,n,r,i,s,a),this.isBlock_?void 0:null!=this.net_&&this.net_.readyState==WebSocket.OPEN?void o(this).sendRequest(this.requests_[a.toString()]):void(null!=this.net_&&this.net_.readyState==WebSocket.CONNECTING||o(this).connect())};var l=i.prototype;l.getReqID=function(){return this.client_.reqID_++,this.client_.reqID_<s&&(this.client_.reqID_=s),this.client_.reqID_},l.sendRequest=function(t){var e=this.client_,n=e.protocol_.build(t.body,t.headers,t.reqID);return"string"==typeof n?void r(function(){var o=e.protocol_.buildFailedMessage(n,t.reqID);e.net_.onmessage({data:o})}):void e.net_.send(n)},l.connect=function(){var t=this.client_;this.client_.normalOnMessage_=function(e){var n=t.protocol_.parse(e);if(n.reqID==u)return void t.onPush(n.data);var o=t.requests_[n.reqID.toString()];return null==o?void console.error("not find request for reqID<"+n.reqID+">"):(o.onComplete(),n.state!=f.Response.State.Success?o.onFailed(new StringView(n.data).toString()):o.onSuccess(n.data),void delete o[n.reqID.toString()])},this.client_.net_=new WebSocket(this.client_.netArgs_),t.net_.haserror=!1,t.net_.binaryType="arraybuffer",t.net_.onmessage=function(e){t.normalOnMessage_(e.data)};var e=setTimeout(function(){t.net_.timeout()},1e3*t.connectTimeout_),n=this;t.net_.onopen=function(o){null!=e&&(clearTimeout(e),e=null),null!=t.blockRequest_?n.sendBlockRequest():n.sendAllRequest(),t.protocol_.onOpen(t.onConnectionSuc_)},t.net_.onclose=function(o){null!=e&&(clearTimeout(e),e=null),t.net_.readyState==WebSocket.OPEN&&(t.net_.close(1e3),t.protocol_.onClose(),t.net_.haserror||(t.net_.haserror=!1,n.netError("connection closed by peer or connection error")))},t.net_.onerror=function(o){t.net_.haserror=!0,null!=e&&(clearTimeout(e),e=null),n.netError("connect error---"+JSON.stringify(o))},t.net_.timeout=function(o){e=null,this.onopen=function(t){},this.onclose=function(t){},this.onerror=function(t){},this.onmessage=function(t){},t.net_=null,n.netError("connect timeout")}},l.sendAllRequest=function(){var t=this.client_;for(var e in t.requests_)this.sendRequest(t.requests_[e])},l.sendBlockRequest=function(){var t=this.client_;t.isBlock_=!0;var e=this,n=function(n){var o=t.protocol_.parse(n),r=!0,i=!0,s=t.blockRequest_;s.onComplete(),o.state!=f.Response.State.Success?(i=!1,s.onFailed(new StringView(o.data).toString())):r=!(s.onSuccess(o.data)===!1),r=r&&i,i||e.errorAllRequest("block request error---"+new StringView(o.data).toString()),r?e.sendAllRequest():i&&e.errorAllRequest("block request stop this request continuing"),t.isBlock_=!1,t.net_.onmessage=function(e){t.normalOnMessage_(e.data)}};t.net_.onmessage=function(t){n(t.data)},this.sendRequest(t.blockRequest_)},l.errorAllRequest=function(t){var e=this.client_;for(var n in e.requests_)!function(n){r(function(){e.normalOnMessage_(e.protocol_.buildFailedMessage(t,n))})}(Number(n))},l.netError=function(t){var e=this.client_;e.isBlock_&&r(function(){var n=e.protocol_.buildFailedMessage(t,a);e.net_.onmessage({data:n})}),this.errorAllRequest(t),e.onConnectionFaild_(t)};var f=t.stm=t.stm||{};f.Client=n}(this);