!function(e){"use strict";function t(e){for(var t in e.requests)e.send(e.requests[t].reqid,e.requests[t].req,e.requests[t].headers)}function n(e,n){var o=!0,i=!0,s=e.protocol.onMessage(e,n);if(null!=s&&void 0!=s||(console.error("BlockRequest parse response error"),o=!1),0!==s.status&&(o=!1),i=i&&o,"function"==typeof e.blockReq.comp&&e.blockReq.comp(),0!==s.status&&"function"==typeof e.blockReq.fail&&e.blockReq.fail(new StringView(s.data).toString()),0===s.status&&"function"==typeof e.blockReq.suc&&(i=i&&!(e.blockReq.suc(s.data)===!1)),e.onMessage=function(t){e.protocol.onMessage(e,t)},e.block=!1,!o)for(var r in e.requests)setTimeout(function(t){return function(){l.onMessage(e,l.buildFailedResponse(t,"BlockRequest error"))}}(r),0);i&&t(e)}function o(e){return null!=e.blockReq&&(e.block=!0,e.onMessage=function(e){n(this,e)},e.send(e.blockReq.reqid,e.blockReq.req,e.blockReq.headers),!0)}function i(e){return(4294967295&++e.reqID)<r&&(e.reqID=r),e.reqID}function s(e){var t=e.ws=new WebSocket(e.url);t.binaryType="arraybuffer",t.onmessage=function(t){e.onMessage(t)};var n=setTimeout(function(){t.timeout()},3e4);t.onopen=function(t){null!=n&&(clearTimeout(n),n=null),e.onOpen(t)},t.onclose=function(o){null!=n&&(clearTimeout(n),n=null),t.readyState==WebSocket.OPEN&&(this.websocket.close(1e3),e.connectFailed("connect closed"))},t.onerror=function(e){console.error("connect error---"+JSON.stringify(e))},t.timeout=function(t){n=null,this.onopen=function(e){},this.onclose=function(e){},this.onerror=function(e){},this.onmessage=function(e){},e.ws=null,e.connectFailed("connect timeout")}}if("function"!=typeof StringView)return void console.error("can not find StringView. you can find in https://developer.mozilla.org/en-US/Add-ons/Code_snippets/StringView or https://github.com/madmurphy/stringview.js");var r=200,u=r-1,a=1,c={send:function(e,t,n,o){console.error("protocol not implement send")},onOpen:function(e){console.error("protocol not implement onOpen")},onMessage:function(e,t){console.error("protocol not implement onMessage")},extend:function(e){if(e.__proto__)e.__proto__=this;else{for(var t in this)this.hasOwnProperty(t)&&!e.hasOwnProperty(t)&&(e[t]=this[t]);this.hasOwnProperty("toString")&&!e.hasOwnProperty("toString")&&(e.toString=this.toString)}return e.$parent=this,e}},l=c.extend({buildFailedResponse:function(e,t){t=new StringView(t);var n=new ArrayBuffer(5+t.rawData.byteLength),o=new DataView(n);o.setUint32(0,e),o.setUint8(4,1);var i=new Uint8Array(n);return i.set(t.rawData,5),{data:n}},send:function(e,t,n,o){var i=this;if("string"!=typeof n&&!(n instanceof ArrayBuffer))return void setTimeout(function(){e.onMessage(i.buildFailedResponse(t,"data type is error, must be string or ArrayBuffer"))},0);if(o=o||{},"object"!=typeof o)return void setTimeout(function(){e.onMessage(i.buildFailedResponse(t,"headers must be a object type, for example {uri: '/location'}"))},0);var s=1024,r=new ArrayBuffer(s),u=0;for(var a in o)if(o.hasOwnProperty(a)){if("string"!=typeof a||"string"!=typeof o[a])return void setTimeout(function(){e.onMessage(i.buildFailedResponse(t,"headers's key and property must be string"))},0);if(0!=a.length&&0!=o[a].length){if(u+1+a.length+1+o[a].length+1>s)return void setTimeout(function(){e.onMessage(i.buildFailedResponse(t,"headers is too long"))},1);new DataView(r).setUint8(u,a.length),u++,new Uint8Array(r).set(new StringView(a).rawData,u),u+=a.length,new DataView(r).setUint8(u,o[a].length),u++,new Uint8Array(r).set(new StringView(o[a]).rawData,u),u+=o[a].length}}new DataView(r).setUint8(u,0),u++,n=new StringView(n);var c=new ArrayBuffer(4+n.rawData.byteLength+u);new DataView(c).setUint32(0,t),new Uint8Array(c).set(new Uint8Array(r,0,u),4),new Uint8Array(c).set(n.rawData,4+u),e.ws.send(c)},onOpen:function(e){o(e)||t(e),e.connectSuccess()},onMessage:function(e,t){var n=new DataView(t.data),o=n.getUint32(0),i=n.getUint8(4);if(o==a)return"function"==typeof e.onPush&&(n=new Uint8Array(t.data,5,t.data.byteLength-5),e.onPush(n)),null;var s=e.requests[o.toString()];if(n=new Uint8Array(t.data,5,t.data.byteLength-5),null==s||void 0==s)return{id:o,status:i,data:n};if("function"==typeof s.comp&&s.comp(),0!==i&&"function"==typeof s.fail){var r=new StringView(n);s.fail(r.toString())}return 0===i&&"function"==typeof s.suc&&s.suc(n),delete e.requests[o.toString()],null}});e.WSClient=function(){this.requests=Object.create(null),this.reqID=r,this.block=!1,this.blockReq=null,this.exponentHex=null,this.modulusHex=null,this.symmetricKey=null,this.url=null,this.connectSuccess=function(){},this.connectFailed=function(){},this.ws=null,this.protocol=l,this.send=function(e,t,n){this.protocol.send(this,e,t,n)},this.onMessage=function(e){this.protocol.onMessage(this,e)},this.onOpen=function(e){this.protocol.onOpen(this)},this.onPush=function(e){}};var f=e.WSClient.prototype;f.setConnectArgs=function(e,t,n){this.url=e,this.connectSuccess=t;var o=this;this.connectFailed=function(e){for(var t in this.requests)setTimeout(function(t){return function(){l.onMessage(o,l.buildFailedResponse(t,e))}}(t),0);"function"==typeof n&&n(e)}},f.setBlockRequestOnConnected=function(e,t,n,o,i){this.blockReq={req:e,suc:t,fail:n,comp:i,reqid:u,headers:o}},f.addRequest=function(e,t,n,o,r){var u=i(this);if(t=t||null,n=n||null,r=r||null,this.requests[u.toString()]={req:e,suc:t,fail:n,comp:r,reqid:u,headers:o},!this.block)return null!=this.ws&&this.ws.readyState==WebSocket.OPEN?void this.send(u,e,o):void(null!=this.ws&&this.ws.readyState==WebSocket.CONNECTING||s(this))}}(this);